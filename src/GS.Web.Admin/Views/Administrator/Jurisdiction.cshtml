
@{
    ViewData["Title"] = "Index";

    string AdminId = (string)ViewBag.AdminId;
}
@section Head{
    <link rel="stylesheet" href="~/layuiadmin/style/admin.css" media="all">
    <style>
        .roleList {
            width: 100%;
            margin-top: 10px;
        }

        .roleItem {
            line-height: 40px;
            height: 40px;
            box-sizing: border-box;
            font-size: 16px;
            text-indent: 10px;
        }

            .roleItem:hover {
                background: #009688;
                color: #fff;
            }

            .roleItem.active {
                background: #009688;
                color: #fff;
            }

        .roleLegendTitle legend {
            font-size: 16px !important;
        }

        .setAllRole {
            line-height: 50px;
            border-bottom: 1px dashed #ccc;
        }

        .setDepartmentRole {
            padding-top: 10px;
            line-height: 30px;
        }

        .setChildRole {
            margin-left: 25px;
        }

        .editName, .editBtn {
            display: none;
        }

            .editName.show, .editBtn.show {
                display: inline-block;
            }
    </style>

}


<div class="layui-fluid" style="height:100%">
    <div class="layui-row " style="height: 100%;">

        <div class="layui-col-md12 layui-col-sm12">
            <layuiForm id="layuiadmin-form-admin" asp-controller="Administrator" asp-action="AdminSetJurisdiction" style="padding: 20px">
                <input type="hidden" name="AdminId" id="AdminId" value="@AdminId" />
                <div class="layui-row layui-col-space10 layui-form" id="formState" style="background:#fff">
                    <div class="layui-col-md9 layui-col-sm8" id="role">
                        <fieldset class="layui-elem-field roleLegendTitle">
                            <legend>功能权限</legend>
                            <div class="layui-field-box">
                                <div class="setAllRole">
                                    <input type="checkbox" class="allCheck" lay-filter='all' name="all" title="全部权限" lay-skin="primary">
                                </div>
                                <div class="" id="setRoleView">

                                </div>

                            </div>

                        </fieldset>

                    </div>
                    <div class="layui-col-md3 layui-col-sm4" style="height: 100%;">
                        <fieldset class="layui-elem-field roleLegendTitle " style="height: 100%;">
                            <legend>数据权限</legend>
                            <div class="layui-field-box">
                                <div id="test1" style="width:200px;overflow-x: auto;overflow-y: hidden; padding-bottom:20px;"></div>
                            </div>
                        </fieldset>

                    </div>

                </div>
            </layuiForm>
        </div>

    </div>


</div>

<script id="demo" type="text/html">
    {{#  layui.each(d, function(index, item){ }}
    <div class="setDepartmentRole" style="border-bottom: 1px dashed #ccc;padding-bottom: 13px;">
        {{#  if(item.isSelect){ }}
        {{#  if(item.isDisabled){ }}
        <input class="parent" lay-filter='other' type="checkbox" name="MenuIds" title="{{item.menuName}}" lay-skin="primary" value="{{item.menuId}}" checked disabled>
        {{#  } else { }}
        <input class="parent" lay-filter='other' type="checkbox" name="MenuIds" title="{{item.menuName}}" lay-skin="primary" value="{{item.menuId}}" checked>
        {{#  }  }}
        {{#  } else { }}
        <input class="parent" lay-filter='other' type="checkbox" name="MenuIds" title="{{item.menuName}}" lay-skin="primary" value="{{item.menuId}}">
        {{#  }  }}

        <div class="setChildRole">

            {{#  layui.each(item.mActionlList, function(index, item1){ }}
            {{#  if(item1.isSelect){ }}
            {{#  if(item1.isDisabled){ }}
            <input type="checkbox" class='child' lay-filter='other' name="operations" title="{{item1.mActionName}}" lay-skin="primary" value="{{item1.mActionId}}" checked disabled>
            {{#  } else { }}
            <input type="checkbox" class='child' lay-filter='other' name="operations" title="{{item1.mActionName}}" lay-skin="primary" value="{{item1.mActionId}}" checked>
            {{#  }  }}
            {{#  } else { }}
            <input type="checkbox" class='child' lay-filter='other' name="operations" title="{{item1.mActionName}}" lay-skin="primary" value="{{item1.mActionId}}">
            {{#  }  }}
            {{#  }); }}

        </div>
    </div>
    {{#  }); }}

</script>


@section Scripts
    {
    <script>
        var layer = layui.layer
            , form = layui.form
            , tree = layui.tree;
        var laytpl = layui.laytpl;
        var adminId = $("#AdminId").val();
        var data = [];
        ; !function () {
            IntData(adminId, Toselect);
            //判断菜单的全选
            function Toselect() {
                $("#role input[type=checkbox]").each(function (index, ele) {
                    var size = $(ele).parent().find(".child").length
                    var check = $(ele).parent().find(".child:checked").length
                    if ($(ele).hasClass("parent") != true) {
                        if (size == check) {
                            $(ele).closest(".setDepartmentRole").find(".parent").prop("checked", true);
                        } else {
                            $(ele).closest(".setDepartmentRole").find(".parent").prop("checked", false);
                        }

                    }
                    size = $(ele).parent().find(".child").length
                    check = $(ele).parent().find(".child:checked").length
                    var total = $(".child").length
                    var checkChild = $(".child:checked").length
                    var checkParent = $(".parent:checked").length
                    var parentTotal = $(".parent").length
                    if (total == 0) {
                        if (checkParent == parentTotal) {
                            $(".allCheck").prop("checked", true)
                        } else {
                            $(".allCheck").prop("checked", false)
                        }
                    } else {
                        if (total == checkChild && parentTotal == checkParent) {
                            $(".allCheck").prop("checked", true)
                        } else {
                            $(".allCheck").prop("checked", false)
                        }
                    }


                })
                form.render('checkbox');

            }


            $("#close").click(function () {
                var index = parent.layer.getFrameIndex(window.name);
                parent.layer.close(index);

            });

        }();




        function IntData(roleId, func) {

            $.ajax({
                type: "post",
                url: "/Administrator/GetRoleJurisdicData",
                data: { adminId: adminId },
                async: true,
                success: function (AjaxData) {
                    $("#roleId").val(roleId);
                    var list = AjaxData.list;
                    showCheck(AjaxData.roleDataAccess);
                    var getTpl = demo.innerHTML;
                    var view = document.getElementById('setRoleView');
                    laytpl(getTpl).render(list, function (html) {
                        view.innerHTML = html;
                    });
                    func();
                }
            });
        }
        function setDisabled() {
            $("#formState input[type=checkbox]").prop("disabled", true)
            form.render('checkbox');
        }
        function clearDisabled() {
            $("#formState input[type=checkbox]").prop("disabled", false)
            form.render('checkbox');
        }
        function showCheck(data) {


            tree.render({
                accordion: true,
                elem: '#test1', //绑定元素
                id: "demotreeId"
                , showCheckbox: true
                , data: data

            });
            setTimeout(function () {
                getData(data)
            }, 100)
            //setDisabled()
            form.on('checkbox(all)', function (data) {
                var check = data.elem.checked
                $("#role input[type=checkbox]").each(function (index, ele) {
                    console.log($(ele).attr("disabled"))
                    if ($(ele).attr("disabled") == undefined) {
                        this.checked = check
                    }
                })
                form.render('checkbox');
            });
            form.on('checkbox(other)', function (data) {
                var element = $(data.elem)
                var size = element.parent().find(".child").length
                var check = element.parent().find(".child:checked").length
                var total = $(".child").length
                var checkChild = $(".child:checked").length
                var checkParent = $(".parent:checked").length
                var parentTotal = $(".parent").length
                if (element.hasClass("parent") == true) {
                    element.parent().find(".child").not(":disabled").prop("checked", data.elem.checked);
                } else {
                    if (size == check) {
                        element.closest(".setDepartmentRole").find(".parent").prop("checked", true);
                    } else {
                        element.closest(".setDepartmentRole").find(".parent").prop("checked", false);
                    }
                    //if (total == checkchild && parenttotal == checkparent) {
                    //    $(".allcheck").prop("checked", true)
                    //} else {
                    //    $(".allcheck").prop("checked", false)
                    //}
                }
                size = element.parent().find(".child").length
                check = element.parent().find(".child:checked").length
                total = $(".child").length
                checkChild = $(".child:checked").length
                checkParent = $(".parent:checked").length
                parentTotal = $(".parent").length
                if (total == 0) {
                    if (checkParent == parentTotal) {
                        $(".allCheck").prop("checked", true)
                    } else {
                        $(".allCheck").prop("checked", false)
                    }
                } else {
                    if (total == checkChild && parentTotal == checkParent) {
                        $(".allCheck").prop("checked", true)
                    } else {
                        $(".allCheck").prop("checked", false)
                    }
                }
                form.render('checkbox');
            });
        }

        function getData(data) {
            for (var i = 0; i < data.length; i++) {
                if (data[i]['children'].length > 0) {
                    getData(data[i]['children'])
                    if (checkSon(data[i]['children'])) {
                        $("#test1").find("input[value=" + data[i]["id"] + "]").attr("checked", true)
                    }
                } else {
                    $("#test1").find("input[value=" + data[i]["id"] + "]").attr("checked", data[i]["checked"])
                }
            }
            form.render('checkbox');
        }
        function checkSon(base) {
            var a = base.length;
            var b = 0;
            for (var i = 0; i < base.length; i++) {
                if (base[i]["checked"]) b = b + 1
            }
            return a == b
        }
    </script>


}

